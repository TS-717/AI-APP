{% extends "base.html" %}

{% block title %}Upload Document - FreelanceTax India{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i data-feather="upload" class="me-2"></i>
                        Upload Invoice or Receipt
                    </h4>
                </div>
                
                <div class="card-body p-5">
                    <!-- Upload Form -->
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        <div class="upload-area border-dashed border-2 border-secondary rounded p-5 text-center mb-4" 
                             id="uploadArea"
                             ondrop="dropHandler(event);" 
                             ondragover="dragOverHandler(event);"
                             ondragenter="dragEnterHandler(event);"
                             ondragleave="dragLeaveHandler(event);">
                            
                            <div class="upload-content">
                                <div class="feature-icon mb-4">
                                    <i data-feather="file-plus" class="text-white" style="width: 32px; height: 32px;"></i>
                                </div>
                                <h5 class="text-white mb-3">Drag & Drop your documents here</h5>
                                <p class="text-white opacity-75 mb-4">or click to browse files</p>
                                
                                <input type="file" 
                                       class="form-control d-none" 
                                       id="fileInput" 
                                       name="file" 
                                       accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp"
                                       onchange="fileSelected(event)">
                                
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                    <i data-feather="folder" class="me-2"></i>
                                    Choose File
                                </button>
                            </div>
                        </div>

                        <!-- File Info Display -->
                        <div id="fileInfo" class="alert alert-info d-none">
                            <div class="d-flex align-items-center">
                                <i data-feather="file" class="me-2"></i>
                                <div class="flex-grow-1">
                                    <strong id="fileName"></strong>
                                    <div class="text-muted small" id="fileDetails"></div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                    <i data-feather="x"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Processing Status -->
                        <div id="processingStatus" class="d-none">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Processing...</span>
                                    </div>
                                    <span id="processingMessage">Processing your document...</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="processingProgress" 
                                         role="progressbar" 
                                         style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i data-feather="zap" class="me-2"></i>
                                Process with AI
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Supported Formats -->
                <div class="card-footer bg-light">
                    <div class="row text-center">
                        <div class="col">
                            <small class="text-muted">
                                <strong>Supported formats:</strong>
                                PDF, PNG, JPG, JPEG, TIFF, BMP
                            </small>
                        </div>
                    </div>
                    <div class="row text-center mt-2">
                        <div class="col">
                            <small class="text-muted">
                                <strong>Max file size:</strong> 16MB
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="card border-0 shadow mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="info" class="me-2"></i>
                        Tips for Best Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i data-feather="check-circle" class="text-success me-2 flex-shrink-0" style="margin-top: 2px;"></i>
                                <div>
                                    <strong>Clear Images</strong>
                                    <p class="text-muted small mb-0">Ensure text is clearly visible and not blurred</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i data-feather="check-circle" class="text-success me-2 flex-shrink-0" style="margin-top: 2px;"></i>
                                <div>
                                    <strong>Good Lighting</strong>
                                    <p class="text-muted small mb-0">Avoid shadows and ensure even lighting</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i data-feather="check-circle" class="text-success me-2 flex-shrink-0" style="margin-top: 2px;"></i>
                                <div>
                                    <strong>Complete Document</strong>
                                    <p class="text-muted small mb-0">Include all pages and important details</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i data-feather="check-circle" class="text-success me-2 flex-shrink-0" style="margin-top: 2px;"></i>
                                <div>
                                    <strong>Straight Orientation</strong>
                                    <p class="text-muted small mb-0">Keep documents straight and not rotated</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- What Gets Extracted -->
            <div class="card border-0 shadow mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="search" class="me-2"></i>
                        What Information Gets Extracted
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i data-feather="dollar-sign" class="text-primary mb-2"></i>
                                <h6>Amount & Currency</h6>
                                <p class="text-muted small">Total amount, GST, and currency identification</p>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="text-center">
                                <i data-feather="calendar" class="text-success mb-2"></i>
                                <h6>Date & Due Date</h6>
                                <p class="text-muted small">Transaction dates and payment terms</p>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="text-center">
                                <i data-feather="user" class="text-warning mb-2"></i>
                                <h6>Client/Vendor</h6>
                                <p class="text-muted small">Business name and contact information</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simplified file upload handling
let selectedFile = null;

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeUpload();
});

function initializeUpload() {
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const uploadForm = document.getElementById('uploadForm');
    
    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });
    }
    
    // Drag and drop
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('border-primary', 'bg-light');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('border-primary', 'bg-light');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('border-primary', 'bg-light');
            handleFileSelect(e.dataTransfer.files[0]);
        });
    }
    
    // Form submission
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            if (!selectedFile) {
                e.preventDefault();
                alert('Please select a file first.');
                return;
            }
            handleFormSubmit();
        });
    }
}

function handleFileSelect(file) {
    if (!file) return;
    
    // Validate file
    if (!validateFile(file)) return;
    
    selectedFile = file;
    showFileInfo(file);
    
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) submitBtn.disabled = false;
}

function validateFile(file) {
    const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/tiff', 'image/bmp'];
    const allowedExtensions = ['pdf', 'png', 'jpg', 'jpeg', 'tiff', 'bmp'];
    const maxSize = 16 * 1024 * 1024; // 16MB
    
    const extension = file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(extension)) {
        alert('Invalid file type. Please upload PDF, PNG, JPG, JPEG, TIFF, or BMP files.');
        return false;
    }
    
    if (file.size > maxSize) {
        alert('File too large. Maximum size is 16MB.');
        return false;
    }
    
    return true;
}

function showFileInfo(file) {
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileDetails = document.getElementById('fileDetails');
    
    if (fileName) fileName.textContent = file.name;
    if (fileDetails) fileDetails.textContent = `Size: ${formatFileSize(file.size)} | Type: ${file.type || 'Unknown'}`;
    if (fileInfo) fileInfo.classList.remove('d-none');
    
    if (typeof feather !== 'undefined') feather.replace();
}

function clearFile() {
    selectedFile = null;
    
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');
    
    if (fileInput) fileInput.value = '';
    if (fileInfo) fileInfo.classList.add('d-none');
    if (submitBtn) submitBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function handleFormSubmit() {
    const processingStatus = document.getElementById('processingStatus');
    const submitBtn = document.getElementById('submitBtn');
    const processingMessage = document.getElementById('processingMessage');
    const progressBar = document.getElementById('processingProgress');
    
    if (processingStatus) processingStatus.classList.remove('d-none');
    if (submitBtn) submitBtn.disabled = true;
    
    // Progress simulation
    if (progressBar && processingMessage) {
        let progress = 0;
        const messages = [
            'Uploading file...',
            'Extracting text with OCR...',
            'Processing with AI...',
            'Calculating taxes...',
            'Finalizing results...'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 85) progress = 85;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * messages.length);
            if (messageIndex < messages.length) {
                processingMessage.textContent = messages[messageIndex];
            }
        }, 800);
        
        setTimeout(() => clearInterval(interval), 15000);
    }
}

// Legacy function names for inline handlers
function dragOverHandler(ev) { ev.preventDefault(); }
function dragEnterHandler(ev) { ev.preventDefault(); }
function dragLeaveHandler(ev) { ev.preventDefault(); }
function dropHandler(ev) { 
    ev.preventDefault();
    handleFileSelect(ev.dataTransfer.files[0]);
}
function fileSelected(event) {
    handleFileSelect(event.target.files[0]);
}

// Initialize feather icons
if (typeof feather !== 'undefined') feather.replace();
</script>
{% endblock %}
