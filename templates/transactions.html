{% extends "base.html" %}

{% block title %}All Transactions - FreelanceTax India{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-2">
                <i data-feather="list" class="me-2"></i>
                All Transactions
            </h1>
            <p class="text-muted">
                Complete record of all processed invoices and receipts
            </p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
                    <i data-feather="plus" class="me-2"></i>Add Transaction
                </a>
                <a href="{{ url_for('export') }}" class="btn btn-outline-secondary">
                    <i data-feather="download" class="me-2"></i>Export Data
                </a>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Search</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by client, description, or amount...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Type</label>
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="freelance_income">Freelance Income</option>
                        <option value="consulting">Consulting</option>
                        <option value="business_travel">Business Travel</option>
                        <option value="office_supplies">Office Supplies</option>
                        <option value="professional_services">Professional Services</option>
                        <option value="marketing">Marketing</option>
                        <option value="utilities">Utilities</option>
                        <option value="rent">Rent</option>
                        <option value="other_business">Other Business</option>
                        <option value="other_income">Other Income</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Date Range</label>
                    <select class="form-select" id="dateFilter">
                        <option value="">All Time</option>
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="this_quarter">This Quarter</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-hover" id="transactionsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Client/Vendor</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center">GST</th>
                                <th class="text-center">Confidence</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            {% for transaction in transactions %}
                            <tr data-transaction-id="{{ transaction.id }}" 
                                data-type="{{ transaction.type }}"
                                data-category="{{ transaction.category }}"
                                data-date="{{ transaction.date }}"
                                data-client="{{ transaction.client_vendor.lower() }}"
                                data-description="{{ transaction.description.lower() }}"
                                data-amount="{{ transaction.amount }}">
                                <td>
                                    <span class="small fw-bold">{{ transaction.date }}</span>
                                    <div class="text-muted small">{{ transaction.timestamp[:10] if transaction.timestamp else '' }}</div>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if transaction.type == 'income' else 'bg-warning' }}">
                                        <i data-feather="{{ 'trending-up' if transaction.type == 'income' else 'trending-down' }}" style="width: 12px; height: 12px;"></i>
                                        {{ transaction.type.title() }}
                                    </span>
                                </td>
                                <td>
                                    <div class="fw-bold">{{ transaction.client_vendor }}</div>
                                    {% if transaction.original_filename %}
                                        <div class="text-muted small">
                                            <i data-feather="file" style="width: 12px; height: 12px;"></i>
                                            {{ transaction.original_filename[:20] }}{% if transaction.original_filename|length > 20 %}...{% endif %}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="description-text">{{ transaction.description }}</div>
                                    {% if transaction.processing_notes %}
                                        <div class="mt-1">
                                            {% for note in transaction.processing_notes %}
                                                <span class="badge bg-warning text-dark small">
                                                    <i data-feather="alert-triangle" style="width: 10px; height: 10px;"></i>
                                                    {{ note }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ transaction.category.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="fw-bold {{ 'text-success' if transaction.type == 'income' else 'text-warning' }}">
                                        ₹{{ "{:,.2f}".format(transaction.amount) }}
                                    </div>
                                    {% if transaction.currency != 'INR' %}
                                        <div class="small text-muted">{{ transaction.currency }}</div>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if transaction.gst_applicable %}
                                        <span class="badge bg-info">
                                            ₹{{ "{:,.2f}".format(transaction.gst_amount) }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="confidence-bar">
                                        {% set confidence_pct = (transaction.confidence * 100) | int %}
                                        <div class="progress" style="height: 8px; width: 50px;">
                                            <div class="progress-bar 
                                                {{ 'bg-success' if confidence_pct >= 80 else 'bg-warning' if confidence_pct >= 60 else 'bg-danger' }}" 
                                                role="progressbar" 
                                                style="width: {{ confidence_pct }}%">
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ confidence_pct }}%</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="viewTransaction('{{ transaction.id }}')"
                                                title="View Details">
                                            <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                onclick="editTransaction('{{ transaction.id }}')"
                                                title="Edit">
                                            <i data-feather="edit-2" style="width: 12px; height: 12px;"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Summary Footer -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-md-3 text-center">
                        <div class="fw-bold text-success" id="totalIncome">₹0.00</div>
                        <small class="text-muted">Total Income</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="fw-bold text-warning" id="totalExpenses">₹0.00</div>
                        <small class="text-muted">Total Expenses</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="fw-bold text-info" id="netAmount">₹0.00</div>
                        <small class="text-muted">Net Amount</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="fw-bold" id="transactionCount">0</div>
                        <small class="text-muted">Transactions Shown</small>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i data-feather="inbox" class="text-muted mb-3" style="width: 64px; height: 64px;"></i>
                    <h5 class="text-muted">No Transactions Yet</h5>
                    <p class="text-muted mb-4">
                        Upload your first invoice or receipt to start tracking your finances
                    </p>
                    <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
                        <i data-feather="upload" class="me-2"></i>Upload Document
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editCurrentTransaction()">Edit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTransactionId = null;
let allTransactions = [];

// Store all transaction data for client-side filtering
document.addEventListener('DOMContentLoaded', function() {
    {% if transactions %}
    allTransactions = {{ transactions | tojsonfilter | safe }};
    {% endif %}
    
    updateSummary();
    setupFilters();
    feather.replace();
});

function setupFilters() {
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const dateFilter = document.getElementById('dateFilter');
    
    [searchInput, typeFilter, categoryFilter, dateFilter].forEach(element => {
        if (element) {
            element.addEventListener('input', filterTransactions);
            element.addEventListener('change', filterTransactions);
        }
    });
}

function filterTransactions() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    const rows = document.querySelectorAll('#transactionsTableBody tr');
    
    rows.forEach(row => {
        const client = row.getAttribute('data-client') || '';
        const description = row.getAttribute('data-description') || '';
        const amount = row.getAttribute('data-amount') || '';
        const type = row.getAttribute('data-type') || '';
        const category = row.getAttribute('data-category') || '';
        const date = row.getAttribute('data-date') || '';
        
        let showRow = true;
        
        // Search filter
        if (searchTerm && !client.includes(searchTerm) && 
            !description.includes(searchTerm) && 
            !amount.includes(searchTerm)) {
            showRow = false;
        }
        
        // Type filter
        if (typeFilter && type !== typeFilter) {
            showRow = false;
        }
        
        // Category filter
        if (categoryFilter && category !== categoryFilter) {
            showRow = false;
        }
        
        // Date filter
        if (dateFilter && !matchesDateFilter(date, dateFilter)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
    });
    
    updateSummary();
    feather.replace();
}

function matchesDateFilter(transactionDate, filter) {
    const date = new Date(transactionDate);
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    switch (filter) {
        case 'this_month':
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        case 'last_month':
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
        case 'this_quarter':
            const quarterStart = Math.floor(currentMonth / 3) * 3;
            return date.getMonth() >= quarterStart && 
                   date.getMonth() <= quarterStart + 2 && 
                   date.getFullYear() === currentYear;
        case 'this_year':
            return date.getFullYear() === currentYear;
        default:
            return true;
    }
}

function updateSummary() {
    const visibleRows = document.querySelectorAll('#transactionsTableBody tr:not([style*="display: none"])');
    let totalIncome = 0;
    let totalExpenses = 0;
    
    visibleRows.forEach(row => {
        const type = row.getAttribute('data-type');
        const amount = parseFloat(row.getAttribute('data-amount')) || 0;
        
        if (type === 'income') {
            totalIncome += amount;
        } else {
            totalExpenses += amount;
        }
    });
    
    const netAmount = totalIncome - totalExpenses;
    
    document.getElementById('totalIncome').textContent = `₹${totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('totalExpenses').textContent = `₹${totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('netAmount').textContent = `₹${netAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('transactionCount').textContent = visibleRows.length;
}

function viewTransaction(transactionId) {
    const transaction = allTransactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    currentTransactionId = transactionId;
    
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Transaction Type</label>
                <div class="form-control-plaintext">
                    <span class="badge ${transaction.type === 'income' ? 'bg-success' : 'bg-warning'}">
                        ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Amount</label>
                <div class="form-control-plaintext fw-bold">
                    ₹${parseFloat(transaction.amount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Date</label>
                <div class="form-control-plaintext">${transaction.date}</div>
            </div>
            <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Category</label>
                <div class="form-control-plaintext">
                    <span class="badge bg-secondary">${transaction.category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                </div>
            </div>
            <div class="col-12">
                <label class="form-label small fw-bold text-muted">Client/Vendor</label>
                <div class="form-control-plaintext">${transaction.client_vendor}</div>
            </div>
            <div class="col-12">
                <label class="form-label small fw-bold text-muted">Description</label>
                <div class="form-control-plaintext">${transaction.description}</div>
            </div>
            ${transaction.gst_applicable ? `
            <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">GST Amount</label>
                <div class="form-control-plaintext">₹${parseFloat(transaction.gst_amount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            </div>
            ` : ''}
            <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Confidence Score</label>
                <div class="form-control-plaintext">${Math.round(transaction.confidence * 100)}%</div>
            </div>
            ${transaction.original_filename ? `
            <div class="col-12">
                <label class="form-label small fw-bold text-muted">Original File</label>
                <div class="form-control-plaintext">${transaction.original_filename}</div>
            </div>
            ` : ''}
            ${transaction.extracted_text ? `
            <div class="col-12">
                <label class="form-label small fw-bold text-muted">Extracted Text (Preview)</label>
                <div class="form-control-plaintext small text-muted" style="max-height: 100px; overflow-y: auto;">
                    ${transaction.extracted_text.substring(0, 300)}${transaction.extracted_text.length > 300 ? '...' : ''}
                </div>
            </div>
            ` : ''}
            ${transaction.processing_notes && transaction.processing_notes.length > 0 ? `
            <div class="col-12">
                <label class="form-label small fw-bold text-muted">Processing Notes</label>
                <div class="form-control-plaintext">
                    ${transaction.processing_notes.map(note => `<span class="badge bg-warning text-dark me-1">${note}</span>`).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('transactionModal')).show();
}

function editTransaction(transactionId) {
    // For now, show transaction details
    // In a full implementation, this would open an edit form
    viewTransaction(transactionId);
}

function editCurrentTransaction() {
    if (currentTransactionId) {
        // Placeholder for edit functionality
        alert('Edit functionality would be implemented here');
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
});
</script>
{% endblock %}
